FROM ubuntu

ARG MAINTAINER="Aleksandar Petrov (alpetrov@ethz.ch)"

# install apt dependencies
RUN apt-get update \
    && apt-get install -y --no-install-recommends \
        python3 python3-pip python3-dev gcc git curl \
    && rm -rf /var/lib/apt/lists/*

# install python dependencies
RUN python3 -m pip install \
    sphinx==3.2.0 \
    sphinx-rtd-theme \
    sphinx-autobuild \
    pygments==2.5.2 \
    mock

# install dts
RUN python3 -m pip install --no-cache-dir --user -U duckietown-shell \
    && export PATH="$PATH:$HOME/.local/bin"

# napoleon needed to reuse the script we use for the ROS repos
RUN cd "/" \
    && git clone https://github.com/AleksandarPetrov/napoleon \
    && cd /napoleon \
    && python3 setup.py install -f

# copy commands
RUN mkdir /commands
COPY . /commands

# put everything in the right place
RUN mkdir -p /docs/source
COPY sphinx_docs/* /docs/source/
COPY devel/docs/build/assets/docs/* /docs/source/
RUN mkdir /docs/html
RUN mkdir /out

COPY devel/docs/build/assets/output-html.manifest.yaml /out

RUN chmod -R 777 /docs

CMD cd /docs \
    && sphinx-build -b html source html \
    && cp -r /docs/html/* /out \
    && tar --create --gzip --file=/docs/html/package.tgz  /out/* \
    || cat /tmp/sphinx-err-*.log

